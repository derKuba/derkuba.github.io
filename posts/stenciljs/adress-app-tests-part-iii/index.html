<!doctype html>
<html lang="de">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>StencilJS-Tutorial: Real World Unit Tests Teil 3</title>
        <meta name="description" content="Module mocking">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="der_kuba">
        <link rel="alternate" href="/feed/feed.json" type="application/json" title="der_kuba">
        <link rel="stylesheet" href="/assets/css/prism.css">
        <link rel="stylesheet" href="/assets/css/bulma.css">
        <link rel="stylesheet" href="/assets/css/custom.css">
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const e = Array
                    .prototype
                    .slice
                    .call(document.querySelectorAll(".navbar-burger"), 0);
                e.length > 0 && e.forEach(e => {
                    e.addEventListener("click", () => {
                        const t = e.dataset.target,
                            a = document.getElementById(t);
                        e.classList.toggle("is-active"),
                        a.classList.toggle("is-active")
                    })
                })
                const disableDarkMode = () => {
                    const bodyNode = document.querySelector("body");
                    bodyNode
                        .classList
                        .remove("dark-mode")
                        localStorage
                        .setItem('darkMode', 'disabled');
                }
                const enableDarkMode = () => {
                    const bodyNode = document.querySelector("body");
                    bodyNode
                        .classList
                        .add("dark-mode")
                        localStorage
                        .setItem('darkMode', 'enabled');
                }
                const button = document.getElementById("darkmode");
                button.addEventListener("click", () => {
                    const bodyNode = document.querySelector("body");
                    if (bodyNode.classList.contains("dark-mode")) {
                        disableDarkMode();
                    } else {
                        enableDarkMode();
                    }
                })
                if (localStorage.getItem('darkMode') === 'enabled') {
                    enableDarkMode();
                }
            });
        </script>
    </head>
    <body><header>
    <div class="container">
        <nav class="navbar">
            <div class="navbar-brand">
                <a class="navbar-item navbar-brand__title " href="/">
                    der_kuba
                </a>
                <a class="navbar-item" href="https://github.com/derKuba">
                    @Github
                </a>
                <a class="navbar-item" href="https://twitter.com/der_kuba">
                    @Twitter
                </a>
                <a class="navbar-item" href="https://www.linkedin.com/in/jacob-pawlik-08a40015b/">
                    @LinkedIn
                </a>
                <div class="navbar-burger" data-target="navigation-items">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div id="navigation-items" class="navbar-menu">
                <div class="navbar-end">
                    
                        <a class="navbar-item " href="/">
                            Home
                        </a>
                        <a class="navbar-item " href="/posts/">
                            Archiv
                        </a>
                        <a class="navbar-item " href="/about/">
                            About Me
                        </a>
                        <a class="navbar-item " href="/en/">
                            English
                        </a>
                        <a class="navbar-item " href="/content/impressum.html">
                            Impressum
                        </a>
                        <a class="navbar-item " href="/content/datenschutz.html">
                            Datenschutzerklärung
                        </a>
                    <button id="darkmode" alt="dark mode">
                        <svg width="30" height="30">
                            <circle cx="15" cy="15" r="6" fill="currentColor"/>
                            <line id="ray" stroke="currentColor" stroke-width="2" stroke-linecap="round" x1="15" y1="1" x2="15" y2="4"></line>
                            <use href="#ray" transform="rotate(45 15 15)"/>
                            <use href="#ray" transform="rotate(90 15 15)"/>
                            <use href="#ray" transform="rotate(135 15 15)"/>
                            <use href="#ray" transform="rotate(180 15 15)"/>
                            <use href="#ray" transform="rotate(225 15 15)"/>
                            <use href="#ray" transform="rotate(270 15 15)"/>
                            <use href="#ray" transform="rotate(315 15 15)"/>
                        </svg>
                    </button>
                    <!-- special thanks to https://www.freecodecamp.org/news/how-to-handle-dark-mode-with-css-and-javascript/ -->
                </div>
            </div>
        </nav>
    </div>
</header>
        
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <h1 class="title is-3">StencilJS-Tutorial: Real World Unit Tests Teil 3</h1>
        <div class="post-detail__tags">
          <h3 class="subtitle is-6">
            <time datetime="2021-09-03">
              03 Sep 2021
            </time>
          </h3>
          <div class="tags"><a href="/tags/stenciljs/" class="post-tag">
                <span class="tag is-black">
                  Stenciljs
                </span>
              </a><a href="/tags/testing/" class="post-tag">
                <span class="tag is-primary">
                  Testing
                </span>
              </a><a href="/tags/jest/" class="post-tag">
                <span class="tag is-link">
                  Jest
                </span>
              </a>
          </div>
        </div>
        <div class="content post_detail__content">
          <div class="language-hint">
            
          </div>
          <p>Im vorherigen Artikel haben wir gelernt wie man einzelne Funktionen wegmockt. In einer Komponente befinden sich häufig auch viele importierte Fremdbibliotheken. Ich verlasse mich immer drauf, dass diese getestet sind und möchte diese auch nicht in meinen Tests erneut testen.
In diesem Artikel zeige ich wie man damit umgeht. <!-- endOfPreview -->Als kleinen Zusatz zeige ich noch auf, wie man mit Timeouts umgeht.</p>
<h4>Module mocken</h4>
<p>Jest hat die Möglichkeit den gesamten Import wegzumocken und eine alternative Implementierung anzubieten. Anstatt einen vielleicht komplizierten Algorithmus auszuführen, entscheide ich selber wie die importe Funktion sich verhalten soll.</p>
<p>Schauen wir uns mal ein Beispiel aus unserer Adressbuch-Applikation an. In der Komponente <em>kuba-address-form</em> benötigen wir beim Anlegen eines neuen Kontakts eine ID, um den Kontakt in den Daten zu identifizieren. Dafür habe ich mir eine Funktion ausgeliehen. Wie sie funktioniert interessiert mich nicht. Sie liefert eine UUID zurück und das reicht mir. Die Funktion liegt in einer eigenen Datei und wird in die Komponente importiert. Daneben liegt auch noch der Store, der auch importiert wird. Diesen möchten wir auch nicht direkt im Test verwenden.</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> create_UUID <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./utils/create-uuid"</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token keyword">import</span> addressStore <span class="token keyword">from</span> <span class="token string">"../../store/address-store"</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">private</span> <span class="token function-variable function">onSubmit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> uuid <span class="token operator">=</span> <span class="token function">create_UUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">     addressStore<span class="token punctuation">.</span>contacts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">        firstName<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstNameState<span class="token punctuation">,</span></span>
<span class="highlight-line">        lastName<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastNameState<span class="token punctuation">,</span></span>
<span class="highlight-line">        id<span class="token operator">:</span> uuid<span class="token punctuation">,</span></span>
<span class="highlight-line">        address<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addressState<span class="token punctuation">,</span></span>
<span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token operator">...</span></span></code></pre>
<p>Wir sehen hier die Funktion <em>create_UUID</em> aus dem Pfad <em>/utils/create-uuid</em>. Es handelt sich um eine selbstgeschriebene Funktion, die auch eigenständig getestet wurde. Sie liefert bei jedem Aufruf eine neue ID zurück und das macht uns beim Test Probleme. Wir bekommen damit keine vergleichbare Daten mehr, da sich die ID nach jedem Aufruf erneuert.
Wir greifen anschließend auf das Store-Objekt zu und beschreiben diese mit den eingegebenen Werten.</p>
<p>Der Test ist so aufgebaut, dass immer zuerst die zu importierenden Module/Funktionen überschrieben werden müssen und erst DANACH wird die zu testende Komponente importiert. Wenn man das umdreht, bekommt die Komponente nicht mehr mit, dass die Importe gemockt wurden. Das ist ein sehr, sehr häufiger Fehlerfall.</p>
<p>Jest bietet für das Überschreiben, bzw. <a href="https://jestjs.io/docs/mock-functions#mocking-partials">Mocken von Modulen die jest.mock()-Funktion</a>. Ich gehe dabei immer so vor, dass ich das zu importierende Modul mocke und direkt eine Implementierung anbiete:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line">jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">"../utils/create-uuid"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> originalModule <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">requireActual</span><span class="token punctuation">(</span><span class="token string">"../utils/create-uuid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        __esModule<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        <span class="token operator">...</span>originalModule<span class="token punctuation">,</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">        <span class="token function-variable function">create_UUID</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"uuid"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">const</span> addressStoreMock <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    contacts<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="highlight-line">jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">"../../../store/address-store"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">    __esModule<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token keyword">default</span><span class="token operator">:</span> addressStoreMock<span class="token punctuation">,</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Die Zeilen 1-11 zeigen die genaue Syntax. Der erste Parameter von jest.mock ist der Pfad zum Import. Der zweite Parameter ist eine Funktion, die das Original-Modul lädt und im Return-Statement alle (nicht vorhandenen Funktionen) destrukturiert. Wir überschreiben hierbei die ( einzige ) Funktion des Moduls <em>create_UUID</em>. Der aufmerksame Leser wird bemerkt haben, dass die Zeile 2 und 5 keinen wirklichen Sinn macht und dass man sie auch weglassen kann. Das ist korrekt. Ich möchte hier zeigen, wie man nur bestimmte Teile des Moduls mockt. Die Funktion <em>create_UUID</em> wird überschrieben und liefert jetzt bei jedem Aufruf nur &quot;uuid&quot; zurück. Damit ist sichergestellt, dass die Daten vergleichbar sind.</p>
<p>Die Zeilen 14-16 zeigen wie man einen Default-Import überschreibt. Die Zeilen davor sind für ein einfaches Modul-Export. Wir erzeugen ein einfaches Objekt, das eine Property contacts hat und übergeben es dem Default. Damit haben wir den Store überschrieben und haben durch die Variable <em>addressStoreMock</em> Zugriff auf den Store und können ihn für jeden Test anpassen. An der Stelle rufe ich zur Vorsicht auf. Das Store Objekt kann von jedem Test angefasst werden und man läuft schnell in eine Abhängigkeit der Reihenfolge der Tests. Ich empfehle den Store vor jedem Test zurückzusetzen:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"kuba-address-form"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        addressStoreMock<span class="token punctuation">.</span>contacts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Jetzt kann man einfach drauf lostesten. Der Test der ein Submit eines neuen Kontaktes testet, sieht dann so aus:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should submit the form on new Contact"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> addressForm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KubaAddressForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>firstNameState <span class="token operator">=</span> <span class="token string">"Max"</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>lastNameState <span class="token operator">=</span> <span class="token string">"Muster"</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>addressState <span class="token operator">=</span> <span class="token string">"HalloWeltWeg 23"</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span><span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>addressStoreMock<span class="token punctuation">.</span>contacts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="highlight-line">        <span class="token punctuation">{</span></span>
<span class="highlight-line">            address<span class="token operator">:</span> <span class="token string">"HalloWeltWeg 23"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            firstName<span class="token operator">:</span> <span class="token string">"Max"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            id<span class="token operator">:</span> <span class="token string">"uuid"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            lastName<span class="token operator">:</span> <span class="token string">"Muster"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Durch die geleistete Vorarbeit ist der Test ganz einfach. Zeile 12 zeigt, dass wir uns auf das von der Funktion <em>create_UUID</em> überschriebene &quot;uuid&quot; verlassen können. Der gemockte Store enthält nach Aufruf der Submit-Methode einen weiteren Eintrag mit den erwarteten Werten. Als Matcher habe ich <em>.toEqual</em> verwendet, weil wir hier nicht auf die Gleichheit der Referenz, sondern des Inhalts überprüfen.</p>
<h4>Weitere Testfälle</h4>
<p><strong>Kontakt editieren</strong></p>
<p>Um in den Kontakt editieren Fall im Code zu gelangen, benötigt man eine ID in der URL. Doch wie bekommt man das im Test hin? Die Funktionalität kommt ja aus dem Framework Stencil-Router. Doch sie benutzt Stencil-Bordmittel. Die ID kommt aus dem Property <em>match</em> vom Typ Matchresult. Genau da setzen wir an:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should submit the form on Contact edit"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token comment">// init</span></span>
<span class="highlight-line">    addressStoreMock<span class="token punctuation">.</span>contacts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">        id<span class="token operator">:</span> <span class="token string">"14"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        firstName<span class="token operator">:</span> <span class="token string">"Max"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        lastName<span class="token operator">:</span> <span class="token string">"Muster"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        address<span class="token operator">:</span> <span class="token string">"Musterstraße 44"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">const</span> addressForm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KubaAddressForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token comment">// hier steht die Lösung</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>match <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token operator">...</span>addressForm<span class="token punctuation">.</span>match<span class="token punctuation">,</span></span>
<span class="highlight-line">        params<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">            id<span class="token operator">:</span> <span class="token string">"14"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//////////////////////</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>firstNameState <span class="token operator">=</span> <span class="token string">"Maximilian"</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>lastNameState <span class="token operator">=</span> <span class="token string">"Neumuster"</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>addressState <span class="token operator">=</span> <span class="token string">"Musterstraße 44"</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span><span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>addressStoreMock<span class="token punctuation">.</span>contacts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="highlight-line">        <span class="token punctuation">{</span></span>
<span class="highlight-line">            address<span class="token operator">:</span> <span class="token string">"Musterstraße 44"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            firstName<span class="token operator">:</span> <span class="token string">"Maximilian"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            id<span class="token operator">:</span> <span class="token string">"14"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            lastName<span class="token operator">:</span> <span class="token string">"Neumuster"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Wir instanziieren die <em>KubaAddressForm</em>. In Zeile 12-18 überschreiben wir mit Hilfe des Spread-Operators das Match-Objekt und geben dem Feld <em>params</em> noch das Feld <em>id</em>. Damit läuft die Implementierung in den <em>else</em>-Fall und wir können wie gewohnt Daten vergleichen.</p>
<p><strong>Lifecycle-Methoden</strong></p>
<p>Stenciljs hat einige Laufzeit-Methoden, mit denen man in das Rendering eingreifen kann. Ich verwende zum Laden der Daten aus dem Store anhand der übergebenen ID die Methode <em>connectedCallback</em>. Diese wird aufgerufen wenn die Komponente initialisiert oder wieder angehängt wird und vor dem Aufruf der Render-Methode. Damit bleibt genug Zeit die Daten zu laden und in den State zu schreiben. Weitere Laufzeitmethoden sind zum Beispiel <em>componentWillLoad</em>, <em>componentWillRender</em> oder <em>componentDidRender</em>. Wer sich für weitere interessiert wird <a href="https://stenciljs.com/docs/component-lifecycle">in der Doku fündig.</a>.</p>
<p>Doch wie bringe ich den Test dazu genau diese Methode auszuführen. Nach viel recherchieren und ausprobieren gehe ich immer so vor. Die Lifecycle Methode ist eine einfache Methode der Klasse. Genau so behandle ich sie auch:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"><span class="token comment">// implementierung</span></span>
<span class="highlight-line"><span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    addressStore<span class="token punctuation">.</span>contacts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>match<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>addressState <span class="token operator">=</span> item<span class="token punctuation">.</span>address<span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>firstNameState <span class="token operator">=</span> item<span class="token punctuation">.</span>firstName<span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>lastNameState <span class="token operator">=</span> item<span class="token punctuation">.</span>lastName<span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>idState <span class="token operator">=</span> item<span class="token punctuation">.</span>id<span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">"connectedCallback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should trigger connectedCallback"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token comment">//init</span></span>
<span class="highlight-line">    <span class="token operator">...</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token comment">// rufe die Methode direkt auf</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token comment">// hier laufen wir in den else Block</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span><span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>match <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token operator">...</span>addressForm<span class="token punctuation">.</span>match<span class="token punctuation">,</span></span>
<span class="highlight-line">        params<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        id<span class="token operator">:</span> <span class="token string">"23"</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token comment">// hier sind wir im if</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span><span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token comment">// jetzt erwarten wir Daten</span></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>addressForm<span class="token punctuation">.</span>addressState <span class="token operator">=</span> <span class="token string">"Musterstraße 44"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>addressForm<span class="token punctuation">.</span>firstNameState <span class="token operator">=</span> <span class="token string">"Max"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>addressForm<span class="token punctuation">.</span>lastNameState <span class="token operator">=</span> <span class="token string">"Muster"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>addressForm<span class="token punctuation">.</span>idState <span class="token operator">=</span> <span class="token string">"23"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<h4>Regex matcher</h4>
<p>Wir haben eine Methode, die UUIDS ausspuckt. Nach jedem Aufruf gibt es eine neue ID. Folglich können wir im Test keine Daten vergleichen, weil diese sich nie gleichen werden. Aber die UUIDs folgen einem festen Pattern. Das ist unser Ansatzpunkt.</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"create-uuid"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should create a uuid"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">const</span> uuid <span class="token operator">=</span> <span class="token function">create_UUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token function">expect</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatch</span><span class="token punctuation">(</span></span>
<span class="highlight-line">            <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\b[0-9a-f]{8}\b-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-\b[0-9a-f]{12}\b</span><span class="token regex-delimiter">/</span></span></span>
<span class="highlight-line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Wir rufen eine neue ID ab. Die vergleichen wir über den Matcher <em>toMatch()</em> (Zeile 4) mit einer REGEX, die ich mir im Internet ausgeliehen habe. Siehe da - ein erfolgreicher Test.</p>
<h4>Timeouts</h4>
<p>Sollte man aus welchen Grund auch immer Timeouts verwenden, bietet Jest auch hier die Möglichkeit zum Testen. In der Komponente <em>KubaAddressForm</em> habe ich einen solchen Fall etwas künstlich erzeugt. In der <em>connectedCallback</em>-Methode führe ich die Logger-Funktion aus, nachdem ich 3 Sekunden gewartet habe. Der einzige Sinn, warum ich das mache, ist um es zu zeigen, dass es geht ;-)
Im Test habe ich die Logger-Funktion mit jest.fn() gemockt und erwarte den Aufruf:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// Implementierung</span></span>
<span class="highlight-line"><span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">"connectedCallback"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment">// Test</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should trigger connectedCallback"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">const</span> loggerMock <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">const</span> addressForm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KubaAddressForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>logger <span class="token operator">=</span> loggerMock<span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span><span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>loggerMock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledWith</span><span class="token punctuation">(</span><span class="token string">"connectedCallback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Wenn man den Test ausführt, sagt die Konsole, dass der LoggerMock nicht aufgerufen wurde. Das ist auch korrekt, weil zur Zeit der Überprüfung wurde er auch nicht ausgeführt. Sondern drei Sekunden später. Damit der Test mitbekommt, dass da ein Timer läuft, muss man Jest mitteilen, dass man Timer gerne faken würde. Danach kann dem Test sagen er soll die Timeouts direkt ausführen.</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// in der obersten Zeilen der Datei außerhalb des Describe-Blocks</span></span>
<span class="highlight-line">jest<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should trigger connectedCallback"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">const</span> loggerMock <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">const</span> addressForm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KubaAddressForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span>logger <span class="token operator">=</span> loggerMock<span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span><span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment">///////////////</span></span>
<span class="highlight-line">    jest<span class="token punctuation">.</span><span class="token function">runAllTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token comment">///////////////</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>loggerMock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledWith</span><span class="token punctuation">(</span><span class="token string">"connectedCallback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Zeile 2 zeigt die Konfiguration für Jest.
In Zeile 16 passiert dann die Magie. Jest lässt alle Timeouts auslaufen und der Test geht erfolgreich durch.</p>
<h5>Fazit</h5>
<p>Heute haben wir weitere Testfälle gelernt. Ab jetzt haben wir für die meisten Fälle das Handwerk Tests zu schreiben. Es gelten keine Ausreden mehr. Ich hoffe ich konnte meine Begeisterung für Jest etwas in Worte fassen und lade alle herzlich ein es auszuprobieren.</p>
<p>Der Code hierzu liegt auf <a href="https://github.com/derKuba/stenciljs-tutorial">Github</a>.</p>
<p>Ihr habt Fragen oder Anregungen? Schreibt mir bei <a href="https://twitter.com/der_kuba">Twitter</a>.
<br>
<br>
Tausend Dank fürs Lesen!</p>
<p>Kuba</p>

            <hr>
              <ul class="post-navigation">
                  <li>Nächster Artikel:
                    <a href="/posts/stenciljs/address-app-e2e/">StencilJS-Tutorial: E2E Tests mit Playwright - Intro</a>
                  </li>
                
                  <li>Vorheriger Artikel:
                    <a href="/posts/stenciljs/adress-app-tests-part-ii/">StencilJS-Tutorial: Real World Unit Tests Teil 2</a>
                  </li>
                
              </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
        <!-- Current page: /posts/stenciljs/adress-app-tests-part-iii/ -->
        <footer class="footer">
    <hr/>
    <div class="content has-text-centered">
        <p>
            der_kuba - 2021-2024 -
            <a href="/content/impressum.html">Impressum</a>
            -
            <a href="/content/datenschutz.html">Datenschutzerklärung</a>
        </p>
    </div>
</footer>
    </body>
</html>