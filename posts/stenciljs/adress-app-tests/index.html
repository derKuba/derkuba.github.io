<!doctype html>
<html lang="de">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>StencilJS-Tutorial: Real World Unit Tests</title>
        <meta name="description" content="Wir testen die Komponenten unserer App">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="der_kuba">
        <link rel="alternate" href="/feed/feed.json" type="application/json" title="der_kuba">
        <link rel="stylesheet" href="/assets/css/prism.css">
        <link rel="stylesheet" href="/assets/css/bulma.css">
        <link rel="stylesheet" href="/assets/css/custom.css">
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const e = Array
                    .prototype
                    .slice
                    .call(document.querySelectorAll(".navbar-burger"), 0);
                e.length > 0 && e.forEach(e => {
                    e.addEventListener("click", () => {
                        const t = e.dataset.target,
                            a = document.getElementById(t);
                        e.classList.toggle("is-active"),
                        a.classList.toggle("is-active")
                    })
                })
                const disableDarkMode = () => {
                    const bodyNode = document.querySelector("body");
                    bodyNode
                        .classList
                        .remove("dark-mode")
                        localStorage
                        .setItem('darkMode', 'disabled');
                }
                const enableDarkMode = () => {
                    const bodyNode = document.querySelector("body");
                    bodyNode
                        .classList
                        .add("dark-mode")
                        localStorage
                        .setItem('darkMode', 'enabled');
                }
                const button = document.getElementById("darkmode");
                button.addEventListener("click", () => {
                    const bodyNode = document.querySelector("body");
                    if (bodyNode.classList.contains("dark-mode")) {
                        disableDarkMode();
                    } else {
                        enableDarkMode();
                    }
                })
                if (localStorage.getItem('darkMode') === 'enabled') {
                    enableDarkMode();
                }
            });
        </script>
    </head>
    <body><header>
    <div class="container">
        <nav class="navbar">
            <div class="navbar-brand">
                <a class="navbar-item navbar-brand__title " href="/">
                    der_kuba
                </a>
                <a class="navbar-item" href="https://github.com/derKuba">
                    @Github
                </a>
                <a class="navbar-item" href="https://twitter.com/der_kuba">
                    @Twitter
                </a>
                <a class="navbar-item" href="https://www.linkedin.com/in/jacob-pawlik-08a40015b/">
                    @LinkedIn
                </a>
                <div class="navbar-burger" data-target="navigation-items">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div id="navigation-items" class="navbar-menu">
                <div class="navbar-end">
                    
                        <a class="navbar-item " href="/">
                            Home
                        </a>
                        <a class="navbar-item " href="/posts/">
                            Archiv
                        </a>
                        <a class="navbar-item " href="/about/">
                            About Me
                        </a>
                        <a class="navbar-item " href="/en/">
                            English
                        </a>
                        <a class="navbar-item " href="/content/impressum.html">
                            Impressum
                        </a>
                        <a class="navbar-item " href="/content/datenschutz.html">
                            Datenschutzerklärung
                        </a>
                    <button id="darkmode" alt="dark mode">
                        <svg width="30" height="30">
                            <circle cx="15" cy="15" r="6" fill="currentColor"/>
                            <line id="ray" stroke="currentColor" stroke-width="2" stroke-linecap="round" x1="15" y1="1" x2="15" y2="4"></line>
                            <use href="#ray" transform="rotate(45 15 15)"/>
                            <use href="#ray" transform="rotate(90 15 15)"/>
                            <use href="#ray" transform="rotate(135 15 15)"/>
                            <use href="#ray" transform="rotate(180 15 15)"/>
                            <use href="#ray" transform="rotate(225 15 15)"/>
                            <use href="#ray" transform="rotate(270 15 15)"/>
                            <use href="#ray" transform="rotate(315 15 15)"/>
                        </svg>
                    </button>
                    <!-- special thanks to https://www.freecodecamp.org/news/how-to-handle-dark-mode-with-css-and-javascript/ -->
                </div>
            </div>
        </nav>
    </div>
</header>
        
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <h1 class="title is-3">StencilJS-Tutorial: Real World Unit Tests</h1>
        <div class="post-detail__tags">
          <h3 class="subtitle is-6">
            <time datetime="2021-08-21">
              21 Aug 2021
            </time>
          </h3>
          <div class="tags"><a href="/tags/stenciljs/" class="post-tag">
                <span class="tag is-black">
                  Stenciljs
                </span>
              </a><a href="/tags/testing/" class="post-tag">
                <span class="tag is-primary">
                  Testing
                </span>
              </a><a href="/tags/jest/" class="post-tag">
                <span class="tag is-link">
                  Jest
                </span>
              </a>
          </div>
        </div>
        <div class="content post_detail__content">
          <div class="language-hint">
            
          </div>
          <p>Nachdem wir <a href="https://derkuba.de/content/posts/stenciljs/jest-intro/">im letzten Artikel</a> die Grundlagen des Testing-Frameworks Jest gelernt haben, wenden wir dieses Wissen in unserem Beispielprojekt <em>Adressbuch</em> an. <!-- endOfPreview -->Kleine Warnung vorab. <a href="https://github.com/ionic-team/stencil/issues/2942">Zurzeit (21.08.21 15:37Uhr)</a> gibt es Probleme zwischen dem <em>stencil-core</em> und der Jest-Version 27. Aktuell bekommt man einen Fehler angezeigt, wenn man die Tests ausführt. Ein Downgrade auf die Version 26 ist die Lösung:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// package.json</span></span>
<span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"><span class="token string-property property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token string-property property">"jest"</span><span class="token operator">:</span> <span class="token string">"^26.0.0"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token string-property property">"jest-cli"</span><span class="token operator">:</span> <span class="token string">"^26.0.0"</span><span class="token punctuation">,</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token operator">...</span></span></code></pre>
<p>Wir haben jetzt die klassische Situation. Wir betreten ein bestehendes Projekt und es sind keine Tests vorhanden. Die Gründe wurden im letzten Artikel erläutert. Aber was nun? Wo und wie geht man vor. Ich empfehle an dieser Stelle erst einmal Jest zu installieren. Häufig ist es im Projekt-Skeleton bereits enthalten. Wenn dies nicht der Fall ist, bitte den <a href="https://derkuba.de/content/posts/stenciljs/jest-intro/">vorherigen Artikel</a> lesen.</p>
<h4>Überlick verschaffen</h4>
<p>Aber wie?</p>
<p>Ich empfehle die Coverage anschauen. Es handelt sich um eine statische Analyse des Codes und das Ergebnis ist ein Überblick welche Teile des Codes Tests durchlaufen.
Das Zauberwort ist <strong>--coverage</strong>.</p>
<pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">npm</span> run <span class="token builtin class-name">test</span> <span class="token parameter variable">--coverage</span></span></code></pre>
<p>Das Ergebnis sieht in meinem Fall so aus:</p>
<pre class="language-bash"><code class="language-bash"><span class="highlight-line">----------------------------------<span class="token operator">|</span>---------<span class="token operator">|</span>----------<span class="token operator">|</span>---------<span class="token operator">|</span>---------<span class="token operator">|</span>----------------------------</span>
<span class="highlight-line">File                              <span class="token operator">|</span> % Stmts <span class="token operator">|</span> % Branch <span class="token operator">|</span> % Funcs <span class="token operator">|</span> % Lines <span class="token operator">|</span> Uncovered Line <span class="token comment">#s</span></span>
<span class="highlight-line">----------------------------------<span class="token operator">|</span>---------<span class="token operator">|</span>----------<span class="token operator">|</span>---------<span class="token operator">|</span>---------<span class="token operator">|</span>----------------------------</span>
<span class="highlight-line">All files                         <span class="token operator">|</span>   <span class="token number">54.55</span> <span class="token operator">|</span>    <span class="token number">15.79</span> <span class="token operator">|</span>   <span class="token number">39.47</span> <span class="token operator">|</span>   <span class="token number">54.64</span> <span class="token operator">|</span></span>
<span class="highlight-line"> components/kuba-address-form     <span class="token operator">|</span>   <span class="token number">30.56</span> <span class="token operator">|</span>        <span class="token number">0</span> <span class="token operator">|</span>   <span class="token number">27.27</span> <span class="token operator">|</span>   <span class="token number">30.56</span> <span class="token operator">|</span></span>
<span class="highlight-line">  kuba-address-form.tsx           <span class="token operator">|</span>   <span class="token number">30.56</span> <span class="token operator">|</span>        <span class="token number">0</span> <span class="token operator">|</span>   <span class="token number">27.27</span> <span class="token operator">|</span>   <span class="token number">30.56</span> <span class="token operator">|</span> <span class="token number">26,34</span>,38,43-47,54-63,67-85</span>
<span class="highlight-line"> components/kuba-button           <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span></span>
<span class="highlight-line">  kuba-button.tsx                 <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span></span>
<span class="highlight-line"> components/kuba-home             <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span></span>
<span class="highlight-line">  kuba-home.tsx                   <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span></span>
<span class="highlight-line"> components/kuba-input            <span class="token operator">|</span>   <span class="token number">66.67</span> <span class="token operator">|</span>        <span class="token number">0</span> <span class="token operator">|</span>      <span class="token number">40</span> <span class="token operator">|</span>   <span class="token number">63.64</span> <span class="token operator">|</span></span>
<span class="highlight-line">  kuba-input-functional.tsx       <span class="token operator">|</span>      <span class="token number">50</span> <span class="token operator">|</span>        <span class="token number">0</span> <span class="token operator">|</span>       <span class="token number">0</span> <span class="token operator">|</span>      <span class="token number">40</span> <span class="token operator">|</span> <span class="token number">16</span>-19</span>
<span class="highlight-line">  kuba-input.tsx                  <span class="token operator">|</span>   <span class="token number">83.33</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>   <span class="token number">66.67</span> <span class="token operator">|</span>   <span class="token number">83.33</span> <span class="token operator">|</span> <span class="token number">20</span></span>
<span class="highlight-line"> components/kuba-list             <span class="token operator">|</span>   <span class="token number">55.56</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">40</span> <span class="token operator">|</span>   <span class="token number">55.56</span> <span class="token operator">|</span></span>
<span class="highlight-line">  kuba-list.tsx                   <span class="token operator">|</span>   <span class="token number">55.56</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">40</span> <span class="token operator">|</span>   <span class="token number">55.56</span> <span class="token operator">|</span> <span class="token number">12</span>-15,37</span>
<span class="highlight-line"> components/kuba-table-attributes <span class="token operator">|</span>      <span class="token number">50</span> <span class="token operator">|</span>       <span class="token number">25</span> <span class="token operator">|</span>      <span class="token number">25</span> <span class="token operator">|</span>      <span class="token number">50</span> <span class="token operator">|</span></span>
<span class="highlight-line">  kuba-table-attributes.tsx       <span class="token operator">|</span>      <span class="token number">50</span> <span class="token operator">|</span>       <span class="token number">25</span> <span class="token operator">|</span>      <span class="token number">25</span> <span class="token operator">|</span>      <span class="token number">50</span> <span class="token operator">|</span> <span class="token number">18</span>-26</span>
<span class="highlight-line"> components/kuba-table-options    <span class="token operator">|</span>   <span class="token number">60.87</span> <span class="token operator">|</span>    <span class="token number">33.33</span> <span class="token operator">|</span>      <span class="token number">40</span> <span class="token operator">|</span>   <span class="token number">63.64</span> <span class="token operator">|</span></span>
<span class="highlight-line">  kuba-table-options.tsx          <span class="token operator">|</span>   <span class="token number">60.87</span> <span class="token operator">|</span>    <span class="token number">33.33</span> <span class="token operator">|</span>      <span class="token number">40</span> <span class="token operator">|</span>   <span class="token number">63.64</span> <span class="token operator">|</span> <span class="token number">25,37</span>,49-73</span>
<span class="highlight-line"> components/kuba-table-slot       <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span></span>
<span class="highlight-line">  kuba-table-slot.tsx             <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span></span>
<span class="highlight-line"> store                            <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span></span>
<span class="highlight-line">  address-store.ts                <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>      <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span>     <span class="token number">100</span> <span class="token operator">|</span></span>
<span class="highlight-line">----------------------------------<span class="token operator">|</span>---------<span class="token operator">|</span>----------<span class="token operator">|</span>---------<span class="token operator">|</span>---------<span class="token operator">|</span>----------------------------</span>
<span class="highlight-line">Test Suites: <span class="token number">7</span> failed, <span class="token number">1</span> passed, <span class="token number">8</span> total</span>
<span class="highlight-line">Tests:       <span class="token number">7</span> failed, <span class="token number">1</span> passed, <span class="token number">8</span> total</span>
<span class="highlight-line">Snapshots:   <span class="token number">1</span> passed, <span class="token number">1</span> total</span>
<span class="highlight-line">Time:        <span class="token number">2.799</span> s</span>
<span class="highlight-line"></span></code></pre>
<p>Wir sehen in der Tabelle, das bereits einige Tests bestehen und wir eine Gesamtabdeckung von 54.55% haben.
Aber das reicht uns natürlich nicht. Zur besseren Übersicht müssen wir noch etwas an der Konfiguration der Tests schrauben:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// stencil.config.ts</span></span>
<span class="highlight-line"><span class="token keyword">export</span> <span class="token keyword">const</span> config<span class="token operator">:</span> Config <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"> testing<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    coverageDirectory<span class="token operator">:</span> <span class="token string">"./reports"</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    coverageReporters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"html"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Führen wir erneut den Testbefehl aus, erhalten wir unter /reports allerlei Dateien. Öffnen wir nun im Browser die <em>index.html</em>:</p>
<p>Diese Einstellung gibt dem Reporter, einem Tool der eine übersichtliche Auswertung innerhalb einer HTML-Seite erstellt, einen Speicherort. Das Flag &quot;text&quot; lässt weiterhin die obige Tabelle auf der Konsole erscheinen.</p>
<p><img src="/content/img/stenciljs-tutorial/jest_html_report.png" alt="jest_html_report" title="Jest HTML Reporter"><div class="has-text-right image-subline">Bild 1: Jest HTML Reporter</div></p>
<p><img src="/content/img/stenciljs-tutorial/jest-kuba-adress-form-report.png" alt="jest-kuba-adress-form-report" title="Jest HTML Reporter"><div class="has-text-right image-subline">Bild 2: Jest HTML Reporter: Adressbuch-Eben</div></p>
<p><img src="/content/img/stenciljs-tutorial/jest-adress-form-snippet.png" alt="jest-adress-form-snippet" title="jest-adress-form-snippet"><div class="has-text-right image-subline">Bild 3: Code-Auszug</div></p>
<p>Das erste Bild zeigt die kunterbunte Auswertung. Es enthält die gleichen Daten wie die Tabelle auf der Konsole. Klickt man aber auf die Komponenten, z.B. auf die <em>components/kuba-adress-form</em> wandert man eine Ebene tiefer (Bild 2). Die Ebenen entsprechen der Ordnerstruktur. Ein weiterer Klick auf den <em>kuba-address-form.tsx</em> lässt den wirklichen Mehrwert erkennen. Wir sehen jetzt auf Code-Ebene welche Teile, wie oft ausgeführt werden. Zusätzlich zeigen die roten Stellen welche Stellen, Funktionen, Verzweigungen ausgelassen wurden. Das ist der Fahrplan für unsere Tests. Man kann sich jetzt Datei für Datei durchhangeln.
Wir starten mit einem einfachen Beispielstest.</p>
<h4>Snapshot-Tests</h4>
<p>Als ich das erste Mal auf diese Art der Tests gestoßen bin, habe ich mich sofort verliebt.</p>
<p>Schauen wir jetzt mal folgenden Test an:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> newSpecPage <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@stencil/core/testing"</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> KubaButton <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../kuba-button"</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"kuba-button"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should render the button"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">newSpecPage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">            components<span class="token operator">:</span> <span class="token punctuation">[</span>KubaButton<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            html<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;kuba-button>&lt;/kuba-button></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token function">expect</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchInlineSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should render the button"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">newSpecPage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">            components<span class="token operator">:</span> <span class="token punctuation">[</span>KubaButton<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="highlight-line">            <span class="token function-variable function">template</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>kuba<span class="token operator">-</span>button handleSubmit<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>kuba<span class="token operator">-</span>button<span class="token operator">></span><span class="token punctuation">,</span></span>
<span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token function">expect</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Wir erkennen den bekannten Testrahmen mit einem <em>describe</em>-Block und zwei <em>it</em>-Blöcke. Wir importieren die zu testende Komponente in Zeile 2 - den KubaButton. In Zeile 7 und 15 wird die Referenz auf diesen Button dem <em>newSpecPage</em>-Objekt des Stencil-Testing-Cors übergeben. Diese wird benötigt, damit Stencil eine Instanz dieser Klasse erstellen kann. Zugriff darauf erhalten wir anschließend über <em>page.rootInstance</em>. Als zweiten Übergabeparameter (Korrekt wäre zu schreiben, dass <em>newSpecPage</em> ein Konfigurationsobjekt mit mehreren Parametern erhält ) können wir zwischen <em>html</em> oder <em>template</em> wählen. Ersteres erhält die zu rendernde Komponente als String. Der Nachteil ist, dass man nur statische String-Parameter übergeben kann. Diesen Nachteil gleicht die zweite Variante <em>template</em> aus. Hier kann man Objekte übergeben. Damit kein Fehler geworfen wird, muss noch das {h} aus dem Core <em>&quot;@stencil/core&quot;</em> importiert werden.
Ein weiterer Unterschied in der Art und Weise dieser Tests findet sich in den Zeilen 10 und 18: <em>toMatch(Inline)Snapshot</em>.</p>
<p>Der Snapshot-Mechanismus speichert ein Abbild des Objekts oder des HTML-Gerüsts in genau diesem Zustand. In der ersten Variante wird das Schnipsel dann als Parameter erzeugt. Im zweiten wird eine Datei unter /<strong>snapshots</strong>/kuba-button.spec.tsx.snap erzeugt, die so aussieht:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// Jest Snapshot v1, https://goo.gl/fbAQLP</span></span>
<span class="highlight-line"></span>
exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">kuba-button renders 2</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
<span class="highlight-line">&lt;kuba-button></span>
<span class="highlight-line">  &lt;mock:shadow-root></span>
<span class="highlight-line">    &lt;button></span>
<span class="highlight-line">      &lt;slot>&lt;/slot></span>
<span class="highlight-line">    &lt;/button></span>
<span class="highlight-line">  &lt;/mock:shadow-root></span>
<span class="highlight-line">&lt;/kuba-button></span>
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="highlight-line"></span>
exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">kuba-button should render the button 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
<span class="highlight-line">&lt;kuba-button></span>
<span class="highlight-line">  &lt;mock:shadow-root></span>
<span class="highlight-line">    &lt;button></span>
<span class="highlight-line">      &lt;slot>&lt;/slot></span>
<span class="highlight-line">    &lt;/button></span>
<span class="highlight-line">  &lt;/mock:shadow-root></span>
<span class="highlight-line">&lt;/kuba-button></span>
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code></pre>
<p>Diese Datei wird eingecheckt. Bei der nächsten Ausführung des Tests wird dann gegen diese Datei verglichen. Sollte es sich etwas geändert haben, zeigt der Test dies auf. So erhält man Feedback, ob die Codeänderung Auswirkung auf die Komponente hatte. War dies gewollt, wird die Datei überschrieben. Wenn nicht, hat man die Gelegenheit seinen Fehler zu korrigieren.</p>
<p>Warum wird dies von mir so gefeiert?</p>
<p>Früher, als jQuery noch state of the art war sah ein Test in PseudoCode so aus:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// jasmine</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">describe <span class="token punctuation">{</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    it<span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">const</span> htmlSnippet <span class="token operator">=</span> <span class="token string">'&lt;div>&lt;button class="kuba-button">&lt;/button>&lt;/div>'</span><span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token function">renderSnippet</span><span class="token punctuation">(</span>htmlSnippet<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".kuba-button"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">        <span class="token comment">// fügt weiteren HTML-Code dazu</span></span>
<span class="highlight-line">        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".kuba-button"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".kuba-button"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"active"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".kuba-button > .neuesKindA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">"Neuer Text"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">         <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".kuba-button > .neuesKindB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">"Ladespinner"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Zugegebenermaßen es sieht sehr ähnlich aus. Worauf ich aber hinaus möchte ist, dass man jede Änderung an der Komponente in einem eigenen Expect abprüfen musste. Jetzt wird der Zustand hergestellt und alle Knoten, die neu dazukommen oder sich ändern, müssen nicht einzeln abgefragt werden.</p>
<h4>Unit-Tests</h4>
<p>Bisher haben wir uns nur um das &quot;Aussehen&quot; der Komponente gekümmert. Aber wie testen man jetzt das Verhalten. Wir bleiben am einfachen Beispiel des &quot;kuba-buttons&quot;. Dieser hat eine private Methode, die das Property aufruft:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">KubaButton</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> handleSubmit<span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">private</span> <span class="token function-variable function">handleClickEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="highlight-line">            <span class="token operator">&lt;</span>Host<span class="token operator">></span></span>
<span class="highlight-line">                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClickEvent<span class="token punctuation">}</span><span class="token operator">></span></span>
<span class="highlight-line">                    <span class="token operator">&lt;</span>slot <span class="token operator">/</span><span class="token operator">></span></span>
<span class="highlight-line">                <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span></span>
<span class="highlight-line">            <span class="token operator">&lt;</span><span class="token operator">/</span>Host<span class="token operator">></span></span>
<span class="highlight-line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Der Test für diese Klasse sieht dann so aus:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should handle click"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> clickMock <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">newSpecPage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">        components<span class="token operator">:</span> <span class="token punctuation">[</span>KubaButton<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        <span class="token function-variable function">template</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>kuba<span class="token operator">-</span>button handleSubmit<span class="token operator">=</span><span class="token punctuation">{</span>clickMock<span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>kuba<span class="token operator">-</span>button<span class="token operator">></span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    page<span class="token punctuation">.</span>body</span>
<span class="highlight-line">        <span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"kuba-button"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">        <span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"button"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">        <span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>clickMock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should handle alternatively"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> clickMock <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">const</span> kubaButton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KubaButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    kubaButton<span class="token punctuation">.</span>handleSubmit <span class="token operator">=</span> clickMock<span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    kubaButton<span class="token punctuation">.</span><span class="token function">handleClickEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>clickMock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Wir sehen wieder die bekannte Teststruktur. Die Zeilen 2 und 17 zeigen ein weiteres elementares Feature von Jest: <em>jest.fn()</em>. Die genaue Funktion beschreibe ich im nächsten Artikel. Für den Moment reicht es zu wissen, dass diese Funktion ein Mock ist und den Übergabeparameter simuliert. Zusätzlich kann bei diesem Mock erfragt werden, ob der Mock in der Implementierung des Buttons aufgerufen wurde.</p>
<p>Aber wie führt man den Aufruf der Methode <em>handleClickEvent</em> herbei? Dazu möchte ich zwei Möglichkeiten aufzeigen:</p>
<ol>
<li>
<p>Operation auf dem DOM.
Wir instanziieren eine SpecPage (Zeile 3). Auf dieser Page stehen uns die bekannten DOM-Operationen zur Verfügung. Wir selektieren den Button (Zeile 9). Achtung! Der Rest der HTML-Struktur ist im <a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Using_shadow_DOM">shadow Dom</a> gekapselt. Dieser muss erst angesteuert werden, um dann darauf den Button zu selektieren ( Zeile 10 ). Da wir den Button im DOM erreicht haben, können wir die native <em>.click()</em>-Funktion aufrufen ( Zeile 11). Damit haben wir das Event ausgelöst. Der Mock sollte ausgelöst worden sein. Dies erfragen wir mit dem <em>expect</em> (Zeile 13).</p>
</li>
<li>
<p>Bei der zweiten Implementierung sollten die Alarmglocken los schrillen. Denn einerseits testet man hier die Implementierung und andererseits eine private Funktion. Ich bin der Meinung, dass man lieber gegen dieses Paradigma verstößt, als dass man auf den Test verzichtet. Ein Aufruf einer privaten Funktion ist in Typescript möglich und der Test läuft auch grün.</p>
</li>
</ol>
<h4>Kleine Kniffe</h4>
<p>Hier noch ein paar kleine Tipps, die den Umgang erleichtern.</p>
<p>Man kann einzelne Tests innerhalb eines <em>describe</em>-Blocks ausschalten/ignorieren:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line">    <span class="token function">xit</span><span class="token punctuation">(</span><span class="token string">"should ..."</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// oder</span></span>
<span class="highlight-line">    it<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token string">"should ..."</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token punctuation">}</span><span class="token comment">// oder gar den ganzen describe-Block</span></span>
<span class="highlight-line">    <span class="token function">xdescribe</span><span class="token punctuation">(</span><span class="token string">"kuba-button"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span></span></code></pre>
<p>Man kann einen Test auch forcieren:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line">    <span class="token function">fit</span><span class="token punctuation">(</span><span class="token string">"should ..."</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// oder</span></span>
<span class="highlight-line">    it<span class="token punctuation">.</span><span class="token function">only</span><span class="token punctuation">(</span><span class="token string">"should ..."</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token punctuation">}</span></span></code></pre>
<p>Man kann beim Ausführen eine Wildcard mitgeben und es wird nach einem Test mit dem Namen als Wildcard gesucht:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line">  npm run test kuba<span class="token operator">-</span>button</span></code></pre>
<h4>Fazit</h4>
<p>Wir haben in diesem Artikel einiges gelernt. Mit diesem Wissen sind wir im Stande die Meisten Tests der Anwendung nachzuholen. Aufgeschoben ist immer besser als aufgehoben. Meiner Meinung nach sind Tests, die nachgeholt werden sehr wertvoll. Man muss sich die Implementierung nochmal anschauen und findet gegebenenfalls Verbesserungen. Man bekommt mehr Sicherheit, um überhaupt Refactoring anzugehen.</p>
<p>Was haben wir gelernt?</p>
<ul>
<li>Snapshot-Tests: Was, warum und wie?</li>
<li>Einfache Unit Tests</li>
<li>Test-Coverage und wie sie bei der Initiierung von Tests hilft.</li>
<li>Tests forcieren und einzelne Tests ausführen</li>
</ul>
<p>Im nächsten Artikel möchte ich tiefer in das Thema Mocking einsteigen und noch weitere Tests zeigen.</p>
<p>Der Code hierzu liegt auf <a href="https://github.com/derKuba/stenciljs-tutorial">Github</a>.</p>
<p>Ihr habt Fragen oder Anregungen? Schreibt mir bei <a href="https://twitter.com/der_kuba">Twitter</a>.
<br>
<br>
Tausend Dank fürs Lesen!</p>
<p>Kuba</p>

            <hr>
              <ul class="post-navigation">
                  <li>Nächster Artikel:
                    <a href="/posts/stenciljs/adress-app-tests-part-ii/">StencilJS-Tutorial: Real World Unit Tests Teil 2</a>
                  </li>
                
                  <li>Vorheriger Artikel:
                    <a href="/posts/stenciljs/jest-intro/">StencilJS-Tutorial: JEST</a>
                  </li>
                
              </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
        <!-- Current page: /posts/stenciljs/adress-app-tests/ -->
        <footer class="footer">
    <hr/>
    <div class="content has-text-centered">
        <p>
            der_kuba - 2021-2024 -
            <a href="/content/impressum.html">Impressum</a>
            -
            <a href="/content/datenschutz.html">Datenschutzerklärung</a>
        </p>
    </div>
</footer>
    </body>
</html>