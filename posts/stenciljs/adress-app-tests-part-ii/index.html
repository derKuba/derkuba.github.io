<!doctype html>
<html lang="de">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>StencilJS-Tutorial: Real World Unit Tests Teil 2</title>
        <meta name="description" content="jest.fn und jest.spyon">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="der_kuba">
        <link rel="alternate" href="/feed/feed.json" type="application/json" title="der_kuba">
        <link rel="stylesheet" href="/assets/css/prism.css">
        <link rel="stylesheet" href="/assets/css/bulma.css">
        <link rel="stylesheet" href="/assets/css/custom.css">
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const e = Array
                    .prototype
                    .slice
                    .call(document.querySelectorAll(".navbar-burger"), 0);
                e.length > 0 && e.forEach(e => {
                    e.addEventListener("click", () => {
                        const t = e.dataset.target,
                            a = document.getElementById(t);
                        e.classList.toggle("is-active"),
                        a.classList.toggle("is-active")
                    })
                })
                const disableDarkMode = () => {
                    const bodyNode = document.querySelector("body");
                    bodyNode
                        .classList
                        .remove("dark-mode")
                        localStorage
                        .setItem('darkMode', 'disabled');
                }
                const enableDarkMode = () => {
                    const bodyNode = document.querySelector("body");
                    bodyNode
                        .classList
                        .add("dark-mode")
                        localStorage
                        .setItem('darkMode', 'enabled');
                }
                const button = document.getElementById("darkmode");
                button.addEventListener("click", () => {
                    const bodyNode = document.querySelector("body");
                    if (bodyNode.classList.contains("dark-mode")) {
                        disableDarkMode();
                    } else {
                        enableDarkMode();
                    }
                })
                if (localStorage.getItem('darkMode') === 'enabled') {
                    enableDarkMode();
                }
            });
        </script>
    </head>
    <body><header>
    <div class="container">
        <nav class="navbar">
            <div class="navbar-brand">
                <a class="navbar-item navbar-brand__title " href="/">
                    der_kuba
                </a>
                <a class="navbar-item" href="https://github.com/derKuba">
                    @Github
                </a>
                <a class="navbar-item" href="https://twitter.com/der_kuba">
                    @Twitter
                </a>
                <a class="navbar-item" href="https://www.linkedin.com/in/jacob-pawlik-08a40015b/">
                    @LinkedIn
                </a>
                <div class="navbar-burger" data-target="navigation-items">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div id="navigation-items" class="navbar-menu">
                <div class="navbar-end">
                    
                        <a class="navbar-item " href="/">
                            Home
                        </a>
                        <a class="navbar-item " href="/posts/">
                            Archiv
                        </a>
                        <a class="navbar-item " href="/about/">
                            About Me
                        </a>
                        <a class="navbar-item " href="/en/">
                            English
                        </a>
                        <a class="navbar-item " href="/content/impressum.html">
                            Impressum
                        </a>
                        <a class="navbar-item " href="/content/datenschutz.html">
                            Datenschutzerklärung
                        </a>
                    <button id="darkmode" alt="dark mode">
                        <svg width="30" height="30">
                            <circle cx="15" cy="15" r="6" fill="currentColor"/>
                            <line id="ray" stroke="currentColor" stroke-width="2" stroke-linecap="round" x1="15" y1="1" x2="15" y2="4"></line>
                            <use href="#ray" transform="rotate(45 15 15)"/>
                            <use href="#ray" transform="rotate(90 15 15)"/>
                            <use href="#ray" transform="rotate(135 15 15)"/>
                            <use href="#ray" transform="rotate(180 15 15)"/>
                            <use href="#ray" transform="rotate(225 15 15)"/>
                            <use href="#ray" transform="rotate(270 15 15)"/>
                            <use href="#ray" transform="rotate(315 15 15)"/>
                        </svg>
                    </button>
                    <!-- special thanks to https://www.freecodecamp.org/news/how-to-handle-dark-mode-with-css-and-javascript/ -->
                </div>
            </div>
        </nav>
    </div>
</header>
        
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <h1 class="title is-3">StencilJS-Tutorial: Real World Unit Tests Teil 2</h1>
        <div class="post-detail__tags">
          <h3 class="subtitle is-6">
            <time datetime="2021-08-27">
              27 Aug 2021
            </time>
          </h3>
          <div class="tags"><a href="/tags/stenciljs/" class="post-tag">
                <span class="tag is-black">
                  Stenciljs
                </span>
              </a><a href="/tags/testing/" class="post-tag">
                <span class="tag is-primary">
                  Testing
                </span>
              </a><a href="/tags/jest/" class="post-tag">
                <span class="tag is-link">
                  Jest
                </span>
              </a>
          </div>
        </div>
        <div class="content post_detail__content">
          <div class="language-hint">
            
          </div>
          <p>Dieser Artikel setzt auf dem letzten <a href="https://derkuba.de/content/posts/stenciljs/adress-app-tests/">Artikel &quot;StencilJS-Tutorial: Real World Unit Tests&quot;</a> auf und gibt weitere Einblicke und Beispiele zum Thema Jest-Testing innerhalb einer StencilJS-App.<!-- endOfPreview --></p>
<h4>Nachtrag Unit-Testing</h4>
<p>Im ersten Teil habe ich gezeigt wie man per DOM-Methoden im Unit-Test die Komponente ansteuert. Der dazugehörige Beispieltest läuft grün. Aber er ist auch sehr simpel. Es gibt keine geschachtelten Webcomponents. Hier möchte ich ein weiteres Beispiel zeigen: <em>kuba-address-form.tsx</em>. Diese Komponente verwendet mehrere weitere Komponenten, wie z.B. das <em>kuba-input</em> und den <em>kuba-button</em>.</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// vereinfachte Darsellung</span></span>
<span class="highlight-line"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Component</span></span></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">class</span></span> KubaAddressForm <span class="token punctuation">{</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function-variable function">onSubmit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token operator">...</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="highlight-line">            <span class="token operator">&lt;</span>Host<span class="token operator">></span></span>
<span class="highlight-line">                <span class="token operator">&lt;</span>kuba<span class="token operator">-</span>input <span class="token operator">/</span><span class="token operator">></span></span>
<span class="highlight-line">                <span class="token operator">&lt;</span>kuba<span class="token operator">-</span>input <span class="token operator">/</span><span class="token operator">></span></span>
<span class="highlight-line">                <span class="token operator">&lt;</span>kuba<span class="token operator">-</span>input <span class="token operator">/</span><span class="token operator">></span></span>
<span class="highlight-line">                <span class="token operator">&lt;</span>kuba<span class="token operator">-</span>button handleClick<span class="token operator">=</span><span class="token punctuation">{</span>onSubmit<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">></span></span>
<span class="highlight-line">            <span class="token operator">&lt;</span><span class="token operator">/</span>Host<span class="token operator">></span></span>
<span class="highlight-line">        <span class="token punctuation">)</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">class</span></span> KubaButton <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>handleClick<span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span></span>
<span class="highlight-line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="highlight-line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="highlight-line">            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&lt;</span>slot<span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span></span>
<span class="highlight-line">        <span class="token punctuation">)</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Mit dem Beispiel zum Thema Test würde so ein Unit-Test aussehen:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// hier kommt man an die Grenze von der newSpecPage</span></span>
<span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should submit the form with query on dom"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">newSpecPage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">        components<span class="token operator">:</span> <span class="token punctuation">[</span>KubaAddressForm<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        html<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;kuba-address-form>&lt;/kuba-address-form></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span></span>
<span class="highlight-line">        page<span class="token punctuation">.</span>body</span>
<span class="highlight-line">            <span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"kuba-address-form"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">            <span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"kuba-button"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML</span>
<span class="highlight-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// möglich! output: speichern</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    page<span class="token punctuation">.</span>body</span>
<span class="highlight-line">        <span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"kuba-address-form"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">        <span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"kuba-button"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">        <span class="token punctuation">.</span>shadowRoot <span class="token comment">// undefined</span></span>
<span class="highlight-line">        <span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"button"</span><span class="token punctuation">)</span></span>
<span class="highlight-line">        <span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token operator">...</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Das Expect habe ich absichtlich weggelassen, weil es gar nicht soweit kommt. Hier stoßen wir an die Grenze vom <em>newSpecPage</em>-Objekt. Es geht hin und mockt alle weiteren Komponenten, die im Render-Block stehen weg. Das bedeutet, dass wir keine Möglichkeit haben per Unit-Test das Click-Event des Buttons innerhalb der Kuba-Button-Komponente zu erreichen.
Der Consolen-Output aus Zeile 8 gibt noch das Label des Buttons aus (&quot;speichern&quot;). Der ShadowDom dahinter ist aber bereits undefined. Mit dieser Art des Tests kommen wir nicht weiter.</p>
<p>Auf dem Click-Event des Buttons liegt aber eine Methode (&quot;onSubmit&quot;), die wir unbedingt testen möchten. An dieser Stelle möchte das Stencil-Framework die Unit-Test-Ebene verlassen und auf die angebotenen e2e-Tests verweisen. In diesen Tests haben wir echte Komponenten und können &quot;seleniumartig&quot; auf diesen operieren. Ich möchte aber lieber nur Unit-Tests schreiben und echte E2E-Tests mit einem echten Browser verwenden.</p>
<p>Die Alternative sieht so aus:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> KubaAddressForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../kuba-address-form"</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should submit the form"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> addressForm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KubaAddressForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span><span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token operator">...</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Wir importieren die Klassenreferenz und erzeugen daraus eine Instanz. Auf dieser können wir alle nötigen Attribute und Methoden aufrufen.</p>
<h4>jest.fn()</h4>
<p>Dies ist ein mächtiger Mock mit ganz viel Funktionalität. Man kann damit Funktionen/Methoden überschreiben und erhält damit die Möglichkeit den Aufruf mitsamt seiner Parameter aufzunehmen und abzufragen. Der Mock kann auch als Instanz verwendet werden, callbacks zurückliefern und Testwerte zurückliefern. Immer dann wenn man den Aufruf irgendeiner Funktion unterbinden oder wegmocken möchte, bietet sich jest.fn() an.</p>
<p>Schauen wir uns ein einfaches Beispiel aus dem Adressbuchprojekt an. Es gibt dort die <em>kuba-input-functional</em>-Komponente, die einen Setter übergeben bekommt. Jedes Mal wenn man etwas in das Textfeld eintippt wird diese Funktion aufgerufen. Genau dies möchten wir nun einmal getestet haben:</p>
<p>Ausimplementiert sieht der Code so aus:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// Implementierung</span></span>
<span class="highlight-line"><span class="token keyword">export</span> <span class="token keyword">const</span> KubaInputFunctional <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">  componentId<span class="token punctuation">,</span></span>
<span class="highlight-line">  label<span class="token punctuation">,</span></span>
<span class="highlight-line">  type<span class="token punctuation">,</span></span>
<span class="highlight-line">  value<span class="token punctuation">,</span></span>
<span class="highlight-line">  setter<span class="token punctuation">,</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="highlight-line">  componentId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="highlight-line">  label<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="highlight-line">  type<span class="token operator">:</span> <span class="token string">"text"</span> <span class="token operator">|</span> <span class="token string">"number"</span><span class="token punctuation">;</span></span>
<span class="highlight-line">  value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="highlight-line">  setter<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">  <span class="token keyword">const</span> <span class="token function-variable function">onInput</span> <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token function">setter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="highlight-line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="highlight-line">    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"kuba-input"</span><span class="token operator">></span></span>
<span class="highlight-line">      <span class="token operator">&lt;</span>label htmlFor<span class="token operator">=</span><span class="token punctuation">{</span>componentId<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>label<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span></span>
<span class="highlight-line">      <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token punctuation">{</span>type<span class="token punctuation">}</span> id<span class="token operator">=</span><span class="token punctuation">{</span>componentId<span class="token punctuation">}</span> value<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span> onInput<span class="token operator">=</span><span class="token punctuation">{</span>onInput<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span></span>
<span class="highlight-line">    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span></span>
<span class="highlight-line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment">// Verwendung in einer Komponente:</span></span>
<span class="highlight-line"></span>
<span class="highlight-line"><span class="token comment">// Methode</span></span>
<span class="highlight-line"><span class="token keyword">private</span> <span class="token function-variable function">onChangeAddress</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> value <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>addressState <span class="token operator">=</span> value<span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token operator">...</span></span>
<span class="highlight-line"><span class="token comment">// renderblock</span></span>
<span class="highlight-line"><span class="token operator">&lt;</span>KubaInputFunctional</span>
<span class="highlight-line">    componentId<span class="token operator">=</span><span class="token string">"street"</span></span>
<span class="highlight-line">    label<span class="token operator">=</span><span class="token string">"Adresse:"</span></span>
<span class="highlight-line">    value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>addressState<span class="token punctuation">}</span></span>
<span class="highlight-line">    type<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"text"</span><span class="token punctuation">}</span></span>
<span class="highlight-line">    setter<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>onChangeAddress<span class="token punctuation">}</span></span>
<span class="highlight-line"><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>KubaInputFunctional<span class="token operator">></span></span>
<span class="highlight-line"><span class="token operator">...</span></span></code></pre>
<p>Wir sehen, dass die onInput-Methode (Zeile 15) im input-Tag (Zeile 21) verwendet wird. Die Property <em>setter</em> (Zeile 8) wird als Funktion in Zeile 17 aufgerufen.
Ab Zeile 28 sehen wir, wie und womit diese Property gefüllt wird. Da setzen wir den Test an:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// kuba-input-functional.spec.tsx</span></span>
<span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should trigger onInputEvent"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> setterMock <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">newSpecPage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="highlight-line">        components<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="highlight-line">        <span class="token function-variable function">template</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span></span>
<span class="highlight-line">            <span class="token operator">&lt;</span>KubaInputFunctional</span>
<span class="highlight-line">                componentId<span class="token operator">=</span><span class="token string">"street"</span></span>
<span class="highlight-line">                label<span class="token operator">=</span><span class="token string">"Adresse:"</span></span>
<span class="highlight-line">                value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">""</span><span class="token punctuation">}</span></span>
<span class="highlight-line">                type<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"text"</span><span class="token punctuation">}</span></span>
<span class="highlight-line">                setter<span class="token operator">=</span><span class="token punctuation">{</span>setterMock<span class="token punctuation">}</span></span>
<span class="highlight-line">            <span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>KubaInputFunctional<span class="token operator">></span></span>
<span class="highlight-line">        <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    page<span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>setterMock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Der Test hat die typischen drei Teile:</p>
<ol>
<li>Initialisierung</li>
<li>Herbeiführen des Zustandes</li>
<li>Erwartungen überprüfen.</li>
</ol>
<p>Im ersten Teil definieren einen <em>setterMock</em> in Zeile 3, indem wir einer Variable das jest.fn() zuweisen. Das den gleichen Wert wie eine ausimplementierte Funktion mit Logik. Diese Funktion übergeben wir der KubaInputFunctional als Property im Attribut von <em>setter</em> (Zeile 13). Damit ist die Initialisierung abgeschlossen.</p>
<p>Im zweiten Teil simulieren wir die Eingabe in das Textfeld. Da das native Input auf das Event &quot;input&quot; lauscht, ist das unser Ansatzpunkt. Wir steuern das <em>input</em> innerhalb der Komponente an (querySelector) und führen auf diesen Knoten den Event aus. Das geschieht über die <em>.dispatchEvent()</em>-Funktion des HTML-Knotens. Diese bekommt als Parameter ein Objekt vom Typ Event oder Customevent übergeben. Diese Events bekommt als Konstruktorparameter den Namen des Events und ggf. Daten übergeben.
Damit wird die Funktion <em>onInput</em> der KubaInputFunctional-Komponente aufgerufen. Man kann dies im Debugger oder per console.log beobachten.</p>
<p>Im dritten Teil müssen wir den Test mit einer Erwartung füttern, damit dieser weiß, ob der Test erfolgreich war. Hier kommt wieder unser <em>setterMock</em> zum Zug. Laut meiner Behauptung speichert ein Mockobjekt seinen Aufruf. Abfragen lässt sich dies mit <em>.toHaveBeenCalled</em> oder <em>toBeCalledWith</em>. Der Test läuft erfolgreich durch. Somit wurde der Mock aufgerufen.
Man kann den Mock auch in seine Aufrufe mitsamt Parametern zerteilen.</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token function">expect</span><span class="token punctuation">(</span>setterMock<span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token comment">// oder</span></span>
<span class="highlight-line"><span class="token function">expect</span><span class="token punctuation">(</span>setterMock<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Hier steht das erste Array für den Aufruf (0: erster Aufruf; 1: zweiter Aufruf)
und das zweite Array für die Parameter (0: erster Parameter; 1: zweiter Parameter);
Damit kann man zusätzlich noch mehrere Aufrufe gleichzeitig testen. Ich habe beide Varianten bzw. Schreibweisen vorgeführt.</p>
<p>Desweiteren kann der Mock Werte zurückliefern:</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line">setterMock<span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">"23"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// und er gibt immer diesen Wert zurück</span></span>
<span class="highlight-line">setterMock<span class="token punctuation">.</span><span class="token function">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token string">"13"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// er gibt einmal diesen Wert zurück</span></span></code></pre>
<h4>jest.spyOn</h4>
<p>Der Spy zählt ebenfalls zu den Mocks. Nur wird hier eine Funktion nicht ersetzt oder überschrieben, sondern man lauert auf den Aufruf. Das ist sehr praktisch wenn man zum Beispiel auf Operationen auf dem <em>windows</em>- oder <em>document</em>-Objekt testen möchte.
Mein Beispiel im Adressbuch-Projekt ist leider sehr konstruiert, aber ich hoffe, dass man verstehen kann worauf ich hinaus möchte.</p>
<p>In der Komponente <em>kuba-address-form</em> gibt es eine Submit-Methode. In dieser habe ich eine Such-Operation auf einen Tag &quot;test&quot; eingebaut. Stellt man sich jetzt vor dieser Aufruf wäre verschachtelt in viele if-Verzweigungen und man möchte diese Testen, kann man auf diese Operation lauschen.</p>
<pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should use a spy"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> documentSpy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>document<span class="token punctuation">,</span> <span class="token string">"getElementById"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token keyword">const</span> addressForm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KubaAddressForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    addressForm<span class="token punctuation">.</span><span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>documentSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line">    <span class="token function">expect</span><span class="token punctuation">(</span>documentSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledWith</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Die Funktion <em>jest.spyOn</em> hat als Parameter das zu belauschende Objekt und den Funktionsnamen. Im Test lauschen wir auf das globale Dokument und im speziellen auf die &quot;getElementById&quot;. In Zeile 2 sieht man die Initialisierung des Spy. Dieser wird dann analog zu <em>jest.fn()</em> behandelt. Man kann nach dem Herbeiführen des Wunschzustandes überprüfen ob das Funktion aufgerufen wurde und/oder mit welchem Parameter aufgerufen wurde. Man könnte diese Überprüfung auch mit jest.fn() ausführen. Aber das bleibt Geschmackssache.</p>
<h4>Fazit</h4>
<p>In diesem Artikel haben wir gelernt, dass das <em>newSpecPage</em>-Objekt nur eine Ebene tief mockt und das zu Problemen beim Unit-Testen führt. Dafür bietet StencilsJS die Hauseigene E2E-Bibliothek an.
Wir haben jest.fn() kennen- und schätzengelernt und am Beispiel gesehen, wie man es nutzen kann. Daneben wurde noch das jest.spyOn als Alternative gezeigt.</p>
<p>Im nächsten Artikel zeige ich wie man komplexere Komponente testes und insbesonders wie man ganze Module mockt.</p>
<p>Der Code hierzu liegt auf <a href="https://github.com/derKuba/stenciljs-tutorial">Github</a>.</p>
<p>Ihr habt Fragen oder Anregungen? Schreibt mir bei <a href="https://twitter.com/der_kuba">Twitter</a>.
<br>
<br>
Tausend Dank fürs Lesen!</p>
<p>Kuba</p>

            <hr>
              <ul class="post-navigation">
                  <li>Nächster Artikel:
                    <a href="/posts/stenciljs/adress-app-tests-part-iii/">StencilJS-Tutorial: Real World Unit Tests Teil 3</a>
                  </li>
                
                  <li>Vorheriger Artikel:
                    <a href="/posts/stenciljs/adress-app-tests/">StencilJS-Tutorial: Real World Unit Tests</a>
                  </li>
                
              </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
        <!-- Current page: /posts/stenciljs/adress-app-tests-part-ii/ -->
        <footer class="footer">
    <hr/>
    <div class="content has-text-centered">
        <p>
            der_kuba - 2021-2024 -
            <a href="/content/impressum.html">Impressum</a>
            -
            <a href="/content/datenschutz.html">Datenschutzerklärung</a>
        </p>
    </div>
</footer>
    </body>
</html>