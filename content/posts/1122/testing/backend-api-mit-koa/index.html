<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>StencilJS-Exkurs: Backend-Api mit Koa</title><meta name="description" content="Wir schreiben ein Backend und binden es an unsere Applikation an"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><link href="/template/css/prism.css" rel="stylesheet"><link rel="stylesheet" href="/template/css/bulma.min.css"><link rel="stylesheet" href="/template/css/custom.css"><link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="der_kuba"><link rel="alternate" href="/feed/feed.json" type="application/json" title="der_kuba"><script>document.addEventListener("DOMContentLoaded",()=>{const e=Array.prototype.slice.call(document.querySelectorAll(".navbar-burger"),0);e.length>0&&e.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.target,a=document.getElementById(t);e.classList.toggle("is-active"),a.classList.toggle("is-active")})})});</script></head><body><header><div class="container"><nav class="navbar is-transparent"><div class="navbar-brand"><a class="navbar-item navbar-brand__title" href="/">der_kuba </a><a class="navbar-item" href="https://github.com/derKuba">@Github </a><a class="navbar-item" href="https://twitter.com/der_kuba">@Twitter</a><div class="navbar-burger" data-target="navigation-items"><span></span> <span></span> <span></span></div></div><div id="navigation-items" class="navbar-menu"><div class="navbar-end"><a class="navbar-item" href="/">Home </a><a class="navbar-item" href="/posts/">Archive </a><a class="navbar-item" href="/content/about/">About Me </a><a class="navbar-item" href="/content/impressum.html">Impressum </a><a class="navbar-item" href="/content/datenschutz.html">Datenschutzerklärung</a></div></div></nav></div></header><section class="section"><div class="container"><div class="columns is-centered"><div class="column is-8"><h1 class="title is-3">StencilJS-Exkurs: Backend-Api mit Koa</h1><div class="post-detail__tags"><h3 class="subtitle is-6"><time datetime="2021-12-17">17 Dec 2021</time></h3><div class="tags"><a href="/tags/web/" class="post-tag"><span class="tag is-black">Web </span></a><a href="/tags/safari/" class="post-tag"><span class="tag is-primary">Safari</span></a></div></div><div class="content post_detail__content"><p>Ein Thema wurde bisher nicht in unserem StencilJS Tutorial nicht behandelt: das Backend. In diesem Artikel erläutere ich wie man ein JS-Backend aufsetzt und einige Routen hinzufügt.</p><h4 id="backend-aufsetzen" tabindex="-1">Backend aufsetzen <a class="direct-link" href="#backend-aufsetzen">#</a></h4><p>Als Technologie habe ich das Koa-Framework ausgewählt. Es wurde wie das sehr populäre ExpressJS vom selben Team Entwickelt und versteht sicht als Weiterentwicklung. Das Team hat seine Learnings zu ExpressJS gesammelt und versucht nun ein noch bessere Javascript-Web-Framework zur Verfügung zu stellen.</p><h5 id="installation" tabindex="-1">Installation <a class="direct-link" href="#installation">#</a></h5><p>Wir erstellen einen Ordner, navigieren dorthin und initialisieren ein NPM-Projekt.</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">mkdir</span> backend</span><br><span class="highlight-line"><span class="token builtin class-name">cd</span> backend</span><br><span class="highlight-line"><span class="token function">npm</span> init</span></code></pre><pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">npm</span> <span class="token function">install</span> koa koa-body-parser @koa/router @koa/cors joi uuid</span></code></pre><p>In dieses Projekt installieren wir</p><ul><li><strong>koa</strong>: den Koa-Core,</li><li><strong>koa-body-parser</strong>: einen Body-Parser, der uns ermöglicht unter anderem Post-Variablen aus dem Request zu lesen</li><li><strong>@koa/router</strong>: um die Routen auszulagern und eine bessere Struktur zu bekommen</li><li><strong>@koa/cors</strong> um Daten aus einer weiteren Quelle zu laden ( nicht aus dem StencilJS Server)</li><li><strong>joi</strong>: für die Request-Validierung</li><li><strong>uuid</strong>: für die Generierung einer einzigartigen ID</li></ul><h5 id="routen" tabindex="-1">Routen <a class="direct-link" href="#routen">#</a></h5><p>Für die Adressbuch-Applikation brauchen wir folgende Routen</p><table><thead><tr><th>Route</th><th style="text-align:center">Methode</th><th style="text-align:center">Erläuterung</th></tr></thead><tbody><tr><td>/contacts</td><td style="text-align:center">GET</td><td style="text-align:center">Hole alle Kontakte</td></tr><tr><td>/contacts/:id</td><td style="text-align:center">GET</td><td style="text-align:center">Hole bestimmten Kontakt mit der variablen ID</td></tr><tr><td>/contacts/</td><td style="text-align:center">POST</td><td style="text-align:center">Lege neuen Kontakt an / Editiere den Kontakt</td></tr><tr><td>/contacts/:id</td><td style="text-align:center">DELETE</td><td style="text-align:center">Lösche den Kontakt</td></tr></tbody></table><p>Ich habe der einfachheit halber auf eine PUT/PATCH Route verzichtet, mit der man eigentlich eine Ressource verändern sollte.</p><h5 id="toolchain" tabindex="-1">ToolChain <a class="direct-link" href="#toolchain">#</a></h5><p><em>Nodemon</em></p><p>Bevor wir mit der Implementierung starten, erweitern wir die Entwicklungs-Toolchain durch ein kleines Modul names <strong>nodemon</strong>. Dieses Modul startet einen Watcher auf unseren Sourcecode und startet nach jeder Änderung den Server neu. Ohne dieses Modul müssten wir nach jedem Speichern den Server manuell neustarten. Es ist eine immense Erleichterung des Workflows.</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-D</span> nodemon</span></code></pre><p>Anschließend fügen wir noch einen Dev-Task in die package.json ein:</p><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// package.json</span></span><br><span class="highlight-line"><span class="token operator">...</span></span><br><span class="highlight-line"> <span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token string-property property">"dev"</span><span class="token operator">:</span> <span class="token string">"nodemon src/index.js"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token operator">...</span></span></code></pre><h5 id="implementierung" tabindex="-1">Implementierung <a class="direct-link" href="#implementierung">#</a></h5><p><em>Routen</em></p><p>Wir legen folgende Dateien an:</p><ul><li>src/index.js</li><li>src/contacts/index.js</li><li>src/contacts/validation.js</li><li>src/utils/uuid.js</li></ul><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// index.js</span></span><br><span class="highlight-line"><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"koa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@koa/cors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"koa-body-parser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> contactRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./contacts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>contactRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">"Hello World"</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Die <em>src/index.js</em>-Datei ist eine Art &quot;Main&quot;-Datei. In ihr wird der Server initialisiert, konfiguriert und gestartet. Es wird eine Instanz der Klasse Koa erstellt und dieser der Bodyparser und das Cors-Modul übergeben. Über <em>app.listen</em> wird der Server gestartet. Als Parameter erhält dieser die Portnummer. In Zeile 11 und Zeile 13-15 sieht man die zugewiesenen Routen. Auf den &quot;ContactRouter&quot; komme ich gleich zurück. Die nächsten Zeilen übergeben eine asynchrone anonyme Arrow-Function, die dem Kontext-Body einen String zuweist. Damit sagt man dem Server, dass er auf der Root-Route (&quot;/&quot;) in den Response Body den String &quot;Hello World&quot; zurückgeben soll.</p><p>Startet man nun diese Datei:</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">node</span> src/index.js</span></code></pre><p>Öffnet man nun zum Beispiel im Browser die Seite unter der URL <strong><a href="http://localhost:3000">http://localhost:3000</a></strong>, erhält man eine weiße Seite mit &quot;Hello World&quot;.</p><h5 id="kontakt-routen" tabindex="-1">Kontakt-Routen <a class="direct-link" href="#kontakt-routen">#</a></h5><p>Wir erstellen die Datei <em>src/contacts/index.js</em>. In diese kommen nun die oben spezifizierten Routen hinein.</p><p>Dafür brauchen wir eine Instanz des <em>Koa/router</em>.</p><pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">"@koa/router"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> contactsRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Diesem Router kann man nun Routen und Request-Methoden zuweisen:</p><pre class="language-js"><code class="language-js"><span class="highlight-line">contactsRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/contacts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">contactsRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/contacts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">contactsRouter<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"/contacts/:id"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Die Datenhaltung wird simuliert. Anstatt eine Datenbank anzubinden, legen wir eine leeres Array an und haben so eine Datenhaltung für die Dauer der Laufzeit der Anwendung. Eingegebene Daten werde beim Schließen des Servers gelöscht. Dieses Array wird nun in die vorgegeben Routen eingebaut und befüllt.</p><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> contacts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// GET</span></span><br><span class="highlight-line">contactsRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/contacts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> contacts<span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Die GET-Route ist sehr simpel. Beim Aufruf wird das Contacts-Array zurückgegeben.</p><p><strong>Kontakt anlegen/editieren</strong></p><pre class="language-js"><code class="language-js"><span class="highlight-line">contactsRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/contacts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> requestData <span class="token operator">=</span> context<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> contactItemIndex <span class="token operator">=</span> contacts<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>id <span class="token operator">===</span> requestData<span class="token punctuation">.</span>id</span><br><span class="highlight-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>contactItemIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        contacts<span class="token punctuation">[</span>contactItemIndex<span class="token punctuation">]</span> <span class="token operator">=</span> requestData<span class="token punctuation">;</span></span><br><span class="highlight-line">        context<span class="token punctuation">.</span>body <span class="token operator">=</span> contacts<span class="token punctuation">[</span>contactItemIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">const</span> contact <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token operator">...</span>requestData<span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        contacts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>contact<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        context<span class="token punctuation">.</span>body <span class="token operator">=</span> contact<span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>In der ersten Version, ohne Validierung, werden die übergeben Daten aus dem request-body ausgelesen. Danach sucht man nach einer Kontakt-ID im Kontakte-Array. An dieser verzweigt sich der Programmierfluss in Abhängigkeit, ob ein Kontakt mit der übergebenen ID gefunden wurde. Wenn ein Kontakt gefunden wurde, befinden man sich im Bearbeiten-Modus eines Kontaktes. In dem Fall wird das Kontakt-Array an der Stelle des Kontaktes mit der gleichen ID überschrieben. Wird kein Kontakt gefunden, befindet man sich im Anlegen-Modus eines Kontaktes. Den übergebenen Daten wird eine UUID zugefügt und dann in das Array geschoben</p><p><strong>Kontakt löschen</strong></p><pre class="language-js"><code class="language-js"><span class="highlight-line">contactsRouter<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"/contacts/:id"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> contactItemIndex <span class="token operator">=</span> contacts<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>id <span class="token operator">===</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id</span><br><span class="highlight-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>contactItemIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        contacts<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>contactItemIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Die Lösch-Route ist analog zur POST-Route. Man sucht anhand der ID den Kontakt im Array und löscht diesen im anschluss. Sollte kein Kontakt zur übergeben ID vorhanden sein, wird ein StatusCode 400 zurückgeliefert.</p><p>Exportiert man nun diese Route am Ende der Datei und importiert diese in die Main-Datei, startet den Server, kann Requests an den Server senden.</p><h5 id="validierung" tabindex="-1">Validierung <a class="direct-link" href="#validierung">#</a></h5><p>Damit die Daten, die man zum Anlegen eines Kontaktes braucht, passen, empfehle ich eine Datenvalidierung. Als Framework empfiehlt sich <a href="https://joi.dev/">Joi</a>, da es ein einfaches und leichtgewichtiges Framework ist. Es wurde bereits installiert und man kann es benutzen.</p><p>Unser Datenobjekt sieht so aus:</p><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token literal-property property">lastName</span><span class="token operator">:</span> string<span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token literal-property property">firstName</span><span class="token operator">:</span> string<span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token literal-property property">adress</span><span class="token operator">:</span> string<span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token literal-property property">id</span><span class="token operator">:</span> string</span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><p>Wir legen die Datei <em>&quot;src/contacts/validation.js&quot;</em> an.</p><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> Joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"joi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> contactValidation <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token literal-property property">lastName</span><span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token literal-property property">firstName</span><span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token literal-property property">address</span><span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token literal-property property">id</span><span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">.</span><span class="token function">guid</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"uuidv4"</span><span class="token punctuation">,</span> <span class="token string">"uuidv5"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">.</span><span class="token function">allow</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> contactValidation<span class="token punctuation">;</span></span></code></pre><p>Joi funktioniert so, dass man ein großes Joi.object anlegt und dort jedes Feld benennt und mit Regeln deklariert. Ich empfehle einen Blick in die <a href="https://joi.dev/api/">Dokumentation</a>, welche übersichtlich und vollständig ist.</p><p>Alle Felder sind Strings und bis auf ID werden alle benötigt.<br>Man erzwingt dieses Verhalten über folgende Signatur:</p><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token operator">*</span><span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Das UUID-Feld ist etwas besonderes, da es einerseits ein bestimmtes Format erwartet und andererseits auch &quot;null&quot; oder leer sein kann. Für das Erkennen von UUIDs hat JOI ein eigenes Datenfeld <em>.guid()</em>. Um ein optionales feld zu deklarieren kann man das .require() weglassen. Zusätzlich erlauben man einen leeren Wert mit <em>.allow(null)</em>.</p><p>Das fertig deklarierte Objekt muss man am Ende noch exportieren.</p><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// src/contacts/index.js</span></span><br><span class="highlight-line"><span class="token keyword">const</span> contactValidation <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./validation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> contactValidation<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    context<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><p>In der Routes-Datei wird dieses Objekt nun importiert. Dieses Validierungsobjekt hat eine Methode, der man den Request-Body übergibt. Als Rückgabeparameter erhält man zwei Werte:</p><ul><li>value: das überprüfte und fehlerfreie Request-Objekt (die POST-Daten)</li><li>error: einen Fehler im Fehlerfall</li></ul><p><strong>fertige Routingdatei /contacts/index.js</strong></p><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@koa/router"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> contactValidation <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./validation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">v4</span><span class="token operator">:</span> uuid <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> contactsRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> contacts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">contactsRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/contacts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> contacts<span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">contactsRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/contacts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> contactValidation<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        context<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> contactItemIndex <span class="token operator">=</span> contacts<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>id <span class="token operator">===</span> value<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>contactItemIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        contacts<span class="token punctuation">[</span>contactItemIndex<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></span><br><span class="highlight-line">        context<span class="token punctuation">.</span>body <span class="token operator">=</span> contacts<span class="token punctuation">[</span>contactItemIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">const</span> contact <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token operator">...</span>value<span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        contacts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>contact<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        context<span class="token punctuation">.</span>body <span class="token operator">=</span> contact<span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">contactsRouter<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"/contacts/:id"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> contactItemIndex <span class="token operator">=</span> contacts<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>id <span class="token operator">===</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id</span><br><span class="highlight-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>contactItemIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        contacts<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>contactItemIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> contactsRouter<span class="token punctuation">;</span></span></code></pre><h4 id="fazit" tabindex="-1">Fazit <a class="direct-link" href="#fazit">#</a></h4><p>In diesem Tutorial wurde eine einfache Backend-API aufgesetzt, die für die Anbindung des Adressbuches dient. Diese Punkte wurden behandelt.</p><ul><li>Aufsetzen des Webservers</li><li>Routes</li><li>Validierung</li></ul><p>Im nächsten Schritt folgt die Anbindung des Adressbuches.</p><p>Der Code hierzu liegt auf <a href="https://github.com/derKuba/stenciljs-tutorial">Github</a>. Um es auf diesen Stand zu bringen, müsst ihr das Projekt klonen und einmal auf den Branch &quot;backend-implementation&quot; auschecken:</p><p>Ihr habt Fragen oder Anregungen? Schreibt mir bei <a href="https://twitter.com/der_kuba">Twitter</a>.<br><br><br>Tausend Dank fürs Lesen!</p><p>Kuba</p><hr><ul class="post-navigation"><li>Nächster Artikel: <a href="/content/posts/1221/backend-api-mit-koa/">StencilJS-Exkurs: Backend-Api mit Koa</a></li><li>Vorheriger Artikel: <a href="/content/posts/1221/ios-safari-pdf-im-neuen-tab/">IOS &amp; Safari: Öffne PDF im neuen Tab</a></li></ul></div></div></div></div></section><footer class="footer"><hr><div class="content has-text-centered"><p>der_kuba - 2021 - <a href="/content/impressum.html">Impressum</a> - <a href="/content/datenschutz.html">Datenschutzerklärung</a></p></div></footer></body></html>