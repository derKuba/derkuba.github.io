<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Contract-Testing mit hurl</title><meta name="description" content="Ein simples Setup für ganze rudimentäre Contract tests"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><link href="/template/css/prism.css" rel="stylesheet"><link rel="stylesheet" href="/template/css/bulma.min.css"><link rel="stylesheet" href="/template/css/custom.css"><link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="der_kuba"><link rel="alternate" href="/feed/feed.json" type="application/json" title="der_kuba"><script>document.addEventListener("DOMContentLoaded",()=>{const e=Array.prototype.slice.call(document.querySelectorAll(".navbar-burger"),0);e.length>0&&e.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.target,a=document.getElementById(t);e.classList.toggle("is-active"),a.classList.toggle("is-active")})})});</script></head><body><header><div class="container"><nav class="navbar is-transparent"><div class="navbar-brand"><a class="navbar-item navbar-brand__title" href="/">der_kuba </a><a class="navbar-item" href="https://github.com/derKuba">@Github </a><a class="navbar-item" href="https://twitter.com/der_kuba">@Twitter</a><div class="navbar-burger" data-target="navigation-items"><span></span> <span></span> <span></span></div></div><div id="navigation-items" class="navbar-menu"><div class="navbar-end"><a class="navbar-item" href="/">Home </a><a class="navbar-item" href="/posts/">Archive </a><a class="navbar-item" href="/content/about/">About Me </a><a class="navbar-item" href="/content/impressum.html">Impressum </a><a class="navbar-item" href="/content/datenschutz.html">Datenschutzerklärung</a></div></div></nav></div></header><section class="section"><div class="container"><div class="columns is-centered"><div class="column is-8"><h1 class="title is-3">Contract-Testing mit hurl</h1><div class="post-detail__tags"><h3 class="subtitle is-6"><time datetime="2023-01-01">01 Jan 2023</time></h3><div class="tags"><a href="/tags/testing/" class="post-tag"><span class="tag is-black">Testing </span></a><a href="/tags/hurl/" class="post-tag"><span class="tag is-primary">Hurl</span></a></div></div><div class="content post_detail__content"><p>Wenn man auf der Testing-Pyramide weiter nach oben wandert, stößt man auf Contract- oder Servicetests. Diese Art von Tests stellen sicher, dass das Frontend mit dem Backend oder den dazugehörigen Services nach Änderungen oder einem Deployment weiterhin funktionieren.</p><p>Im Prinzip geht es darum eine bestimmte Antwort der Schnittstelle sicherzustellen. In diesem Beispiel werden echte Requests an die Schnittstelle gesendet. Das erzeugt einiges an Traffic und Last auf den echten Services. Diesen Weg würde ich nur gehen, wenn man sich nicht auf einen echten Contract mit dem Backend einigen kann.</p><p>Wenn es geht würde ich <a href="https://docs.pact.io/">PACT</a> empfehlen. Dabei stellt ein Broker sicher, dass der Contract (eine JSON-Datei) noch funktioniert. Man muss aber einiges an Aufwand und Infrastruktur bereitstellen.</p><p>Vor einem Jahr habe ich diese Tests noch selber geschrieben. Mit nodeJS habe ich <em>fetch</em>-Aufrufe, programmatisch, gegen mein &quot;Backend&quot; geschossen und so sichergestellt, dass mein Frontend weiterhin kompatibel ist. Ein Kollege hat mich vor einiger Zeit auf <a href="https://hurl.dev/">hurl</a> aufmerksam gemacht. Dieses Framework übernimmt die Arbeit Requests abzusenden, sammelt die Testdateien ein und gibt eine schöne Zusammenfassung der Tests wieder. Des Weiteren gibt es ein HTML-Report, die Möglichkeit Variablen in eine .env-Datei auszulagern und viele Vergleichsoperationen.</p><p><img src="/content/img/0123/hurl.png" alt="Hurl" title="hurl testing"></p><p>Heute zeige ich anhand eines kleinen Backends wie man bestimmte Daten und Cookies erwartet, .env-Dateien verwendet und das HTML-Reporting ausgibt. Alles integriert in einem NPM-Projekt.</p><h3 id="installation" tabindex="-1">Installation <a class="direct-link" href="#installation">#</a></h3><p>Um es in npm zu integrieren legen wir ein neues Projekt an:</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">mkdir</span> contract-testing</span><br><span class="highlight-line"><span class="token function">npm</span> init <span class="token parameter variable">-y</span></span></code></pre><p>Jetzt fehlt noch hurl:</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">npm</span> <span class="token function">install</span> @orangeopensource/hurl</span></code></pre><p>Jetzt fehlen noch die Test-Dateien im Testordner. Die Dateiendung .hurl verrät hurl, dass dort die Tests hinterlegt werden:</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">mkdir</span> contract-test</span><br><span class="highlight-line"><span class="token builtin class-name">cd</span> contract-test</span><br><span class="highlight-line"><span class="token function">touch</span> simple.hurl</span><br><span class="highlight-line"><span class="token function">touch</span> cookie.hurl</span><br><span class="highlight-line"><span class="token function">touch</span> content.hurl</span></code></pre><p>Der erste Test sieht so aus:</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line">// simple.hurl</span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># is application running</span></span><br><span class="highlight-line">GET http://localhost:3000/random</span><br><span class="highlight-line">HTTP/1.1 <span class="token number">200</span></span></code></pre><p>Es wird ein <em>GET</em> gegen eine URL gesendet. Als Antwort wird ein Status Code 200 im HTTP 1.1-Protokoll erwartet.</p><p>Für die Ausführung fehlt in der <em>package.json</em> noch das passende Script:</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line">// package.json_</span><br><span class="highlight-line"><span class="token string">"scripts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">   <span class="token string">"test:contract"</span><span class="token builtin class-name">:</span> <span class="token string">"hurl --test --glob contract-test/*.hurl --report-html ./reports --variables-file ./contract-test/contract-testing.env"</span></span><br><span class="highlight-line"> <span class="token punctuation">}</span>,</span></code></pre><p>Der Befehl startet mit hurl mit folgenden Optionen:</p><table><thead><tr><th>Option</th><th>Bedeutung</th></tr></thead><tbody><tr><td>--test</td><td>startet hurl als test tool und angepassten Output. --glob</td></tr><tr><td>--glob</td><td>gibt den Ort und die Benennung der Testdateien an.</td></tr><tr><td>--report-html</td><td>gibt den Speicherort für den HTML-Report an</td></tr><tr><td>--variables-file</td><td>benennt die .env-Datei mit Umgebungsvariablen an</td></tr></tbody></table><p>Jetzt muss man die Tests nur noch ausführen:</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">npm</span> run test:contract</span></code></pre><p>Die Ausgabe sollte dann folgendermaßen aussehen:</p><pre class="language-bash"><code class="language-bash"><span class="highlight-line">contract-test/cookies.hurl: Running <span class="token punctuation">[</span><span class="token number">1</span>/3<span class="token punctuation">]</span></span><br><span class="highlight-line">contract-test/cookies.hurl: Success <span class="token punctuation">(</span><span class="token number">1</span> request<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span> ms<span class="token punctuation">)</span></span><br><span class="highlight-line">contract-test/simple.hurl: Running <span class="token punctuation">[</span><span class="token number">2</span>/3<span class="token punctuation">]</span></span><br><span class="highlight-line">contract-test/simple.hurl: Success <span class="token punctuation">(</span><span class="token number">1</span> request<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span> ms<span class="token punctuation">)</span></span><br><span class="highlight-line">contract-test/content.hurl: Running <span class="token punctuation">[</span><span class="token number">3</span>/3<span class="token punctuation">]</span></span><br><span class="highlight-line">contract-test/content.hurl: Success <span class="token punctuation">(</span><span class="token number">1</span> request<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span> ms<span class="token punctuation">)</span></span><br><span class="highlight-line">--------------------------------------------------------------------------------</span><br><span class="highlight-line">Executed files:  <span class="token number">3</span></span><br><span class="highlight-line">Succeeded files: <span class="token number">3</span> <span class="token punctuation">(</span><span class="token number">100.0</span>%<span class="token punctuation">)</span></span><br><span class="highlight-line">Failed files:    <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span>%<span class="token punctuation">)</span></span><br><span class="highlight-line">Duration:        <span class="token number">4</span> ms</span><br><span class="highlight-line"></span></code></pre><h3 id="tests" tabindex="-1">Tests <a class="direct-link" href="#tests">#</a></h3><p>Das vorhandene Backend gibt nicht viel her. Unter der Route <em>/random</em> gibt es ein JSON zurück, das ich mit Hilfe von <a href="https://json-generator.com/">JSON-Generator</a> erstellt habe. Zusätzlich habe ich noch einen Cookie eingefügt.</p><p><img src="/content/img/0123/jsonResponse.png" alt="JSON Response" title="json response"></p><p><img src="/content/img/0123/cookie.png" alt="Cookie" title="cookie"></p><p>Aber es reicht um den wesentlichen Nutzen zu zeigen. Man stellt sicher, dass ein bestimmter Aufruf eine vordefinierte Antwort liefert.</p><h3 id="get-%26-post" tabindex="-1">GET &amp; POST <a class="direct-link" href="#get-%26-post">#</a></h3><pre class="language-ts"><code class="language-ts"><span class="highlight-line"># validate response</span><br><span class="highlight-line"><span class="token constant">GET</span> <span class="token operator">/</span>random</span><br><span class="highlight-line"><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span></span><br><span class="highlight-line"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string-property property">"_id"</span><span class="token operator">:</span><span class="token string">"63b17cafa115a1682550035e"</span><span class="token punctuation">,</span><span class="token string-property property">"index"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>"gui<span class="token operator">...</span> achtung gekürzt</span><br><span class="highlight-line"></span><br><span class="highlight-line"># send post request</span><br><span class="highlight-line"><span class="token constant">POST</span> <span class="token operator">/</span>random</span><br><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token string-property property">"name"</span> <span class="token operator">:</span> <span class="token string">"Kuba"</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token punctuation">[</span>Asserts<span class="token punctuation">]</span></span><br><span class="highlight-line">body contains <span class="token string">"Hello Kuba"</span></span></code></pre><p>Der erste Test ruft die URL auf (Zeile 2). In Zeile 3 wird wie oben auf das Protokoll und den Status Code geprüft. Die nächste Zeile enthält das zu erwartende JSON. Weicht es um eine Stelle ab, wird dieser Test scheitern.</p><p>Der nächste Test ist ein POST-Request. Es wird ein JSON übermittelt (Zeile 8-9). Nach Prüfung des Protokolls und des Status Codes, folgt der <em>Asserts</em>-Block. Hier kann man nun Vergleiche anstellen. Unter <a href="https://hurl.dev/docs/asserting-response.html">https://hurl.dev/docs/asserting-response.html</a> sieht man das Set, das zur Verfügung steht: status, header, url, cookie, body, bytes, xpath, jsonpath, regex, sha256, md5, variable, duration.</p><p>Ich verwende <em>body</em> und schaue ob der Inhalt die Zeichenkette &quot;Hello Kuba&quot; enthält. Der eigenen Kreativität ist hier kaum eine Grenze gesetzt.</p><h3 id="cookie" tabindex="-1">Cookie <a class="direct-link" href="#cookie">#</a></h3><pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// cookie.hurl</span></span><br><span class="highlight-line"><span class="token constant">GET</span> <span class="token operator">/</span>random</span><br><span class="highlight-line"><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token punctuation">[</span>Asserts<span class="token punctuation">]</span></span><br><span class="highlight-line">cookie <span class="token string">"foo"</span> exists</span><br><span class="highlight-line">cookie <span class="token string">"foo[HttpOnly]"</span> exists</span><br><span class="highlight-line">cookie <span class="token string">"foo[Secure]"</span> exists</span><br><span class="highlight-line">cookie <span class="token string">"foo[SameSite]"</span> equals <span class="token string">"Lax"</span></span></code></pre><p>In diesem Test werden die Werte des Cookies im oben vorgestellten <em>Assert</em>-Block überprüft. Dafür steht das Keyword <em>cookie</em> bereit. Es sucht den benannten Cookie und überprüft auch deren Werte.</p><h3 id="die-.env-datei" tabindex="-1">Die .env-Datei <a class="direct-link" href="#die-.env-datei">#</a></h3><p>Um in verschiedenen Umgebungen Umgebungsvariablen anzubieten gibt es die oben beschriebene Option <em>--variables-file</em>. In dieser können Variablen abgelegt werden:</p><pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token comment">// contract-testing.env</span></span><br><span class="highlight-line">base_url<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span></span></code></pre><p>In dieser lege ich die <em>base_url</em> ab. Natürlich kann diese je nach Umgebung variieren. Hier könnte man z.B. auch Logindateien ablegen.</p><p>In den HURL-Dateien kann danach darauf zugegriffen werden:</p><pre class="language-ts"><code class="language-ts"><span class="highlight-line"><span class="token constant">GET</span> <span class="token operator">/</span>random</span><br><span class="highlight-line"><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span></span></code></pre><p>Dem findigen Leser ist dies bereits aufgefallen. Achtung! Möchte man auf diese Variablen nun im POST-Body zugreifen, muss dieser in drei Hochkommata stehen.</p><h3 id="der-html-report" tabindex="-1">Der HTML-Report <a class="direct-link" href="#der-html-report">#</a></h3><p>Die Option _--report-html ./reports _ sorgt dafür, dass nach dem Ausführen ein Order <em>reports</em> erscheint. In dieser befindet sich eine HTML-Datei, die ausgefürt so aussieht:</p><p><img src="/content/img/0123/hurl-report.png" alt="hurl report" title="Reporting"></p><p>In dieser Werten die Ausführungen aneinandergereiht und man sieht welche gescheitert sind und welche nicht. Es ist ein nettes Feature und hat nicht eine sehr große Informationsdichte. Aber es wird bestimmt in weiteren Releasen erweitert.</p><h3 id="fazit" tabindex="-1">Fazit <a class="direct-link" href="#fazit">#</a></h3><p>Dieser Artikel gibt einen Einblick wie man diese Art von Tests ein- und ausführt. Der Nutzen ist sehr offensichtlich. Es ist ein praktisches und einfaches Tool. Ich wünsche euch damit sehr viel Spaß!</p><p>Der Code hierzu liegt auf <a href="https://github.com/derKuba/contract-testing">Github</a>.</p><p>Ihr habt Fragen oder Anregungen? Schreibt mir bei <a href="https://twitter.com/der_kuba">Twitter</a> oder bei <a href="https://www.linkedin.com/in/jacob-pawlik-08a40015b/">LinkedIn</a>.<br><br>Tausend Dank fürs Lesen!</p><p>Kuba</p><hr><ul class="post-navigation"><li>Vorheriger Artikel: <a href="/content/posts/1222/agile/planning2/">Planning 2: Ablauf für Devs</a></li></ul></div></div></div></div></section><footer class="footer"><hr><div class="content has-text-centered"><p>der_kuba - 2023 - <a href="/content/impressum.html">Impressum</a> - <a href="/content/datenschutz.html">Datenschutzerklärung</a></p></div></footer></body></html>